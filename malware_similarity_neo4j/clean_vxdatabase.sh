#!/bin/bash
# Extract Families 7z

# Remove Papers directories
find . -type d -name "Paper" -exec rm -rf {} +
find . -type d -name "Papers" -exec rm -rf {} +

# Decompress all zip and 7z files
find . -type f -name "*.7z" -exec sh -c '7z e -p"infected" -y -o"$(dirname "{}")" "{}" && rm -f "{}"' \; # -y pour forcer Ã  yes
# find . -type f -name "*.zip" -exec sh -c 'unzip -P "infected" -y -d "$(dirname "{}")" "{}" && rm -f "{}"' \;

# Malformatted filenames :
# find . -type f | grep -E '^[^_]*(_[^_]*){0,1}[^_]*$' | grep -v -e txt -e ioc
# ./WARP/WARP_sample/C0134285A276AB933E2A2B9B33B103CD

# Command to solve the issue
find . -type f | grep -E '^[^_]*(_[^_]*){0,1}[^_]*$' | grep -v -e txt -e ioc | while read -r filepath; do \
  find "$(dirname "$filepath")" -maxdepth 1 -name "$(basename "$filepath")" -exec bash -c ' \
    for file; do \
      dir=$(dirname "$file"); \
      filename=$(basename "$file"); \
      parent_folder=$(basename "$dir"); \
      mv "$file" "$dir/${parent_folder}_$filename"; \
    done' bash {} +; \
done
